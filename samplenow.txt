const express=require("express");
// const path=require("path");
// const app=express();
// const session = require("express-session");
// const otpGenerator = require('otp-generator')
 const multer=require("multer");
// const nodemailer=require("nodemailer")
 const mongoose=require("mongoose");
// const { error } = require("console");
// const grid = require('gridfs-stream');
// // app.use(express.urlencoded({ extended: false ,limit: '50mb'}));
// // app.use(express.static(path.join(__dirname,"public")));
// const jwt=require("jsonwebtoken")
// const cookieParser=require("cookie-parser")
// const bodyParser = require('body-parser');
// // app.use(cookieParser())
// // app.use(express.json({ limit: '50mb' }));
// const { stringify } = require('querystring');
 var router = express.Router();
 const storage=multer.memoryStorage();
 const upload=multer({storage:storage});
// app.use(bodyParser.urlencoded({ extended: true }));
 const {employerprotect}=require("../middleware/employerprotect");
// var {jobschema,Corejob,Softwarejob}=require("../model/jobschemacoll");
// var Applicationcollection=require("../model/appschemacoll");
// var Employerdetail=require("../model/employerschemacoll");
const {employerloginhandler,employersendotp,employerloginverifyotp,employerloginconfirmpassword,findcandidate,findcandidatecompany,mypostfindcandidatecompany,getDocuments,getDocumentscompany,getCompanySuggestions,viewResumelink,sendmail,submitmail,jobpost,postjob,viewyourposts}=require("../controllers/employerlogincontroller.js")
router.get("/employerloginhandler",employerloginhandler)

router.get("/employerforgotpassword",(req,res)=>{
    res.render("employerforgotpassword.ejs");
})

router.post("/employersendotp",employersendotp)
router.post("/employerloginverifyotp",employerloginverifyotp)

router.post("/employerloginconfirmpassword",employerloginconfirmpassword)
    const newjobschema=new mongoose.Schema({
        companyname:{type:String,required:true
        },
        jobname:{type:String,
            required:true},

    openings: {type:Number,
            required:true},
    lastdate:{type:String,
              required:true},
     description:{
        type:String,
        required:true
     },
    logo:{
        data:Buffer,
        contentType:String

    }
      })
router.post("/findcandidate",employerprotect,findcandidate)
router.get("/findcandidatecompany",employerprotect,findcandidatecompany)
   router.get("/mypostfindcandidatecompany",employerprotect,mypostfindcandidatecompany)
   router.get("/getDocuments",employerprotect,getDocuments)
router.get("/getDocumentscompany",employerprotect,getDocumentscompany)
router.get("/getCompanySuggestions",employerprotect, getCompanySuggestions);
router.get("/viewResumelink",employerprotect,viewResumelink);
router.get("/sendmail",employerprotect,sendmail)

router.post("/submitmail",upload.single('attachment'),employerprotect,submitmail);
router.get("/jobpost",employerprotect,jobpost)
router.post("/postjob",upload.single("logo"),employerprotect,postjob)

// const start=async()=>{
// try{
//   app.listen(5000,()=>{
//       console.log("hurray u got connected");
//   })
//   //deekshithareddy2223
//   //gXkPedRi3ZJadM22
  
  
// }
// catch(error)
// {
//   console.log(error)

// }
// }
router.get("/viewyourposts",employerprotect,viewyourposts)
// router.get("/employerlogout",(req,res)=>{
//   res.clearCookie('employerjwt'); 
//     res.render('../views/index.ejs'); 
// })


module.exports=router




router.post("/employerlogin",async(req,res)=>{
    
    
    const email2=req.body.email1;
    const pass1=req.body.password1;
    const result =await Employerdetail.findOne({email:email2,eligible:true})
    const result1=await Employerdetail.countDocuments({email:email2,eligible:true})
    //const resultn=await db1.find({});
    try{
    if(result1)
    {  
    const result2 = await bcrypt.compare(pass1, result.pass);
    const token= result.tokens[0].token;
    console.log(token)
    if(result2>0)
    {
        res.cookie("employerjwt",token,{
            maxAge:10000000,
            httpOnly:true
        });
        res.render('../views/employerabout.ejs',{user:result.name});
    }
    else{
        console.log(email2);
        console.log(pass1);
        console.log(result2);
        console.log(result1);
        res.render('../views/employerlogin.ejs',{message:"wrong password"});
    } 
    }
    else{
        //console.log(resultn);
        console.log(email2);
        console.log(result1);
        res.render('../views/employerlogin.ejs',{message:"you don't have account"});
    }}
    catch (error) {
        console.error('Error comparing passwords:', error);
      }
    
    
})
